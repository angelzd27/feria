<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registros de Detención</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background-color: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            max-width: 1600px;
            margin: 0 auto;
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 10px;
            font-size: 32px;
        }
        .subtitle {
            text-align: center;
            color: #7f8c8d;
            margin-bottom: 30px;
        }
        .upload-section {
            text-align: center;
            margin-bottom: 30px;
            padding: 40px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 12px;
            border: 3px dashed #95a5a6;
        }
        .upload-section.dragover {
            background: linear-gradient(135deg, #d5dbdb 0%, #a8b5c4 100%);
            border-color: #3498db;
        }
        .file-input-wrapper {
            position: relative;
            display: inline-block;
            margin: 20px 0;
        }
        .file-input-label {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            padding: 14px 28px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            display: inline-block;
            transition: all 0.3s;
        }
        .file-input-label:hover {
            background: linear-gradient(135deg, #2980b9 0%, #21618c 100%);
        }
        #fileInput {
            display: none;
        }
        .file-name {
            margin-top: 15px;
            color: #34495e;
            font-weight: 500;
        }
        .download-section {
            text-align: center;
            margin: 30px 0;
            padding: 25px;
            background: linear-gradient(135deg, #d5f4e6 0%, #80e1b5 100%);
            border-radius: 12px;
            display: none;
        }
        .download-section.show {
            display: block;
        }
        .btn {
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            margin: 5px;
            transition: all 0.3s;
        }
        .btn:hover {
            transform: translateY(-2px);
        }
        .btn-excel {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
        }
        .btn-pdf {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }
        .btn-reset {
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
            display: none;
        }
        .stats.show {
            display: grid;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            transition: transform 0.3s;
        }
        .stat-card:hover {
            transform: translateY(-5px);
        }
        .stat-number {
            font-size: 36px;
            font-weight: bold;
        }
        .stat-label {
            font-size: 14px;
            margin-top: 8px;
            opacity: 0.9;
        }
        .charts-section {
            display: none;
            margin-bottom: 30px;
        }
        .charts-section.show {
            display: block;
        }
        .carousel-container {
            position: relative;
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 50px;
            box-sizing: border-box;
        }
        .carousel-viewport {
            overflow: hidden;
            width: 100%;
        }
        .carousel-track {
            display: flex;
            width: 400%;
            transition: transform 0.5s ease-in-out;
        }
        .chart-container {
            width: 25%;
            flex-shrink: 0;
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            box-sizing: border-box;
        }
        .carousel-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(44, 62, 80, 0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 24px;
            cursor: pointer;
            transition: background-color 0.3s;
            z-index: 10;
        }
        .carousel-btn:hover:not(:disabled) {
            background-color: rgba(44, 62, 80, 1);
        }
        .carousel-btn:disabled {
            background-color: rgba(149, 165, 166, 0.5);
            cursor: not-allowed;
        }
        #prevChartBtn {
            left: 0;
        }
        #nextChartBtn {
            right: 0;
        }
        .chart-title {
            font-size: 20px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 20px;
            text-align: center;
        }
        canvas {
            max-height: 400px;
        }
        .table-controls {
            display: none;
            margin-bottom: 15px;
        }
        .table-controls.show {
            display: block;
        }
        #searchInput {
            width: 100%;
            padding: 12px 15px;
            border-radius: 8px;
            border: 2px solid #ddd;
            font-size: 16px;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }
        #searchInput:focus {
            outline: none;
            border-color: #667eea;
        }
        .pagination-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 20px;
            display: none;
        }
        .pagination-controls.show {
            display: flex;
        }
        .pagination-controls button {
            background: #34495e;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 0 10px;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .pagination-controls button:hover:not(:disabled) {
            background: #2c3e50;
        }
        .pagination-controls button:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }
        .pagination-controls span {
            font-weight: 600;
            color: #2c3e50;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 12px;
            display: none;
        }
        table.show {
            display: table;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            vertical-align: top;
        }
        th {
            background-color: #34495e;
            color: white;
            font-weight: bold;
            position: sticky;
            top: 0;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        tr:hover {
            background-color: #f5f5f5;
        }
        .persona {
            font-weight: bold;
            color: #2980b9;
        }
        .dias {
            text-align: center;
            font-weight: bold;
            color: #e74c3c;
        }
        .delito {
            font-weight: bold;
            color: #8e44ad;
        }
        .detalle {
            max-width: 400px;
            word-wrap: break-word;
            font-size: 11px;
        }
        .error-message {
            color: #e74c3c;
            background-color: #fadbd8;
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
            display: none;
        }
        .info-message {
            color: #2980b9;
            background-color: #d6eaf8;
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
        }
        .section-divider {
            height: 2px;
            background: linear-gradient(90deg, transparent, #667eea, transparent);
            margin: 40px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Registros de Detención</h1>
        <p class="subtitle">Feria San Miguel de Allende 2025</p>
        
        <div class="upload-section" id="uploadSection">
            <h2>Cargar Archivo CSV</h2>
            <p>Arrastra y suelta tu archivo CSV aquí o haz clic para seleccionar</p>
            <div class="file-input-wrapper">
                <label for="fileInput" class="file-input-label">Seleccionar Archivo CSV</label>
                <input type="file" id="fileInput" accept=".csv,.txt">
            </div>
            <div class="file-name" id="fileName"></div>
            
            <div class="info-message">
                <strong>Formato esperado:</strong><br>
                El archivo CSV debe contener las columnas:<br>
                <code>persona, dias_distintos, fechas_detectado, delitos, detalle_delito</code>
            </div>
        </div>

        <div class="error-message" id="errorMessage"></div>

        <div class="download-section" id="downloadSection">
            <p><strong>Archivo cargado correctamente</strong></p>
            <button class="btn btn-excel" onclick="downloadExcel()">Descargar Excel</button>
            <button class="btn btn-pdf" onclick="downloadPDF()">Descargar PDF</button>
            <button class="btn btn-reset" onclick="resetApp()">Cargar Otro Archivo</button>
        </div>

        <div class="stats" id="stats">
             <div class="stat-card">
                <div class="stat-number" id="totalPersonas">0</div>
                <div class="stat-label">Total de Personas</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalDetenciones">0</div>
                <div class="stat-label">Total de Detenciones</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="promedioDetenciones">0</div>
                <div class="stat-label">Promedio por Persona</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="maxDetenciones">0</div>
                <div class="stat-label">Máximo Detenciones</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="faltasAdmin">0</div>
                <div class="stat-label">Faltas Administrativas</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="disposiciones">0</div>
                <div class="stat-label">Disposiciones</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="reincidentes">0</div>
                <div class="stat-label">Reincidentes (3+ días)</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="medianaDetenciones">0</div>
                <div class="stat-label">Mediana de Detenciones</div>
            </div>
        </div>

        <div class="section-divider"></div>

        <div class="charts-section" id="chartsSection">
            <div class="carousel-container">
                <button id="prevChartBtn" class="carousel-btn">‹</button>
                <div class="carousel-viewport">
                    <div class="carousel-track" id="carouselTrack">
                        <div class="chart-container">
                            <div class="chart-title">Distribución de Detenciones</div>
                            <canvas id="distributionChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <div class="chart-title">Top 10 Personas con Más Detenciones</div>
                            <canvas id="topPersonsChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <div class="chart-title">Tipos de Delitos</div>
                            <canvas id="delitosChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <div class="chart-title">Detenciones por Día de la Semana</div>
                            <canvas id="weekdayChart"></canvas>
                        </div>
                    </div>
                </div>
                <button id="nextChartBtn" class="carousel-btn">›</button>
            </div>
        </div>
        <div class="section-divider"></div>

        <div class="table-controls" id="tableControls">
            <input type="text" id="searchInput" placeholder="Buscar en la tabla...">
        </div>

        <table id="dataTable">
            <thead>
                <tr>
                    <th>Persona</th>
                    <th>Días Distintos</th>
                    <th>Fechas Detectado</th>
                    <th>Delitos</th>
                    <th>Detalle del Delito</th>
                </tr>
            </thead>
            <tbody id="tableBody">
            </tbody>
        </table>
        
        <div class="pagination-controls" id="paginationControls">
            <button id="prevPageBtn">Anterior</button>
            <span id="pageInfo"></span>
            <button id="nextPageBtn">Siguiente</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

    <script>
    // --- VARIABLES GLOBALES ---
    let parsedData = [];
    let filteredData = [];
    let charts = {};
    let currentPage = 1;
    const rowsPerPage = 10;
    let currentChartIndex = 0;
    // --- FIN DE VARIABLES ---

    const fileInput = document.getElementById('fileInput');
    const uploadSection = document.getElementById('uploadSection');
    const fileName = document.getElementById('fileName');
    const errorMessage = document.getElementById('errorMessage');
    const downloadSection = document.getElementById('downloadSection');
    const stats = document.getElementById('stats');
    const chartsSection = document.getElementById('chartsSection');
    const dataTable = document.getElementById('dataTable');
    const tableBody = document.getElementById('tableBody');
    
    const tableControls = document.getElementById('tableControls');
    const searchInput = document.getElementById('searchInput');
    const paginationControls = document.getElementById('paginationControls');
    const prevPageBtn = document.getElementById('prevPageBtn');
    const nextPageBtn = document.getElementById('nextPageBtn');
    const pageInfo = document.getElementById('pageInfo');

    const carouselTrack = document.getElementById('carouselTrack');
    const prevChartBtn = document.getElementById('prevChartBtn');
    const nextChartBtn = document.getElementById('nextChartBtn');
    const totalCharts = 4;

    // --- EVENT LISTENERS ---
    fileInput.addEventListener('change', handleFileSelect);
    uploadSection.addEventListener('dragover', (e) => { e.preventDefault(); uploadSection.classList.add('dragover'); });
    uploadSection.addEventListener('dragleave', () => { uploadSection.classList.remove('dragover'); });
    uploadSection.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadSection.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length > 0) handleFile(files[0]);
    });
    searchInput.addEventListener('input', () => {
        currentPage = 1;
        displayData();
    });
    prevPageBtn.addEventListener('click', () => {
        if (currentPage > 1) {
            currentPage--;
            displayData();
        }
    });
    nextPageBtn.addEventListener('click', () => {
        const totalPages = Math.ceil(filteredData.length / rowsPerPage);
        if (currentPage < totalPages) {
            currentPage++;
            displayData();
        }
    });
    
    prevChartBtn.addEventListener('click', () => {
        currentChartIndex = (currentChartIndex - 1 + totalCharts) % totalCharts;
        updateChartCarousel();
    });
    nextChartBtn.addEventListener('click', () => {
        currentChartIndex = (currentChartIndex + 1) % totalCharts;
        updateChartCarousel();
    });

    function handleFileSelect(e) {
        const file = e.target.files[0];
        if (file) handleFile(file);
    }

    function handleFile(file) {
        if (!file.name.endsWith('.csv') && !file.name.endsWith('.txt')) {
            showError('Por favor selecciona un archivo CSV válido');
            return;
        }
        fileName.textContent = `Archivo: ${file.name}`;
        hideError();
        Papa.parse(file, {
            header: true,
            skipEmptyLines: true,
            dynamicTyping: true,
            complete: function(results) { processData(results.data); },
            error: function(error) { showError('Error al leer el archivo: ' + error.message); }
        });
    }

    function processData(data) {
        if (data.length === 0) {
            showError('El archivo CSV está vacío');
            return;
        }
        const requiredColumns = ['persona', 'dias_distintos', 'fechas_detectado', 'delitos', 'detalle_delito'];
        const columns = Object.keys(data[0]);
        const missingColumns = requiredColumns.filter(col => !columns.includes(col));
        if (missingColumns.length > 0) {
            showError('Faltan las siguientes columnas: ' + missingColumns.join(', '));
            return;
        }

        parsedData = data;
        calculateStats(data);
        createCharts(data);
        
        currentPage = 1;
        searchInput.value = '';
        displayData();
        
        downloadSection.classList.add('show');
    }

    function displayData() {
        const searchTerm = searchInput.value.toLowerCase();
        filteredData = parsedData.filter(row => {
            return Object.values(row).some(value => 
                String(value).toLowerCase().includes(searchTerm)
            );
        });

        const totalPages = Math.ceil(filteredData.length / rowsPerPage);
        const start = (currentPage - 1) * rowsPerPage;
        const end = start + rowsPerPage;
        const paginatedData = filteredData.slice(start, end);

        tableBody.innerHTML = '';
        paginatedData.forEach(row => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="persona">${row.persona || ''}</td>
                <td class="dias">${row.dias_distintos || ''}</td>
                <td>${row.fechas_detectado || ''}</td>
                <td class="delito">${row.delitos || ''}</td>
                <td class="detalle">${row.detalle_delito || ''}</td>
            `;
            tableBody.appendChild(tr);
        });
        
        if (parsedData.length > 0) {
            dataTable.classList.add('show');
            tableControls.classList.add('show');
            paginationControls.classList.add('show');
            updatePaginationControls(totalPages);
        } else {
            dataTable.classList.remove('show');
            tableControls.classList.remove('show');
            paginationControls.classList.remove('show');
        }
    }

    function updatePaginationControls(totalPages) {
        pageInfo.textContent = `Página ${currentPage} de ${totalPages > 0 ? totalPages : 1}`;
        prevPageBtn.disabled = currentPage === 1;
        nextPageBtn.disabled = currentPage === totalPages || totalPages === 0;
    }

    function calculateStats(data) {
        const totalPersonas = data.length;
        const diasArray = data.map(row => parseInt(row.dias_distintos) || 0);
        const totalDetenciones = diasArray.reduce((sum, val) => sum + val, 0);
        const promedio = totalPersonas > 0 ? (totalDetenciones / totalPersonas).toFixed(1) : 0;
        const maxDetenciones = Math.max(...diasArray);
        
        const faltasAdmin = data.filter(row => (row.delitos || '').toUpperCase().includes('FALTA ADMINISTRATIVA')).length;
        const disposiciones = data.filter(row => (row.delitos || '').toUpperCase().includes('DISPOSICIÓN') || (row.delitos || '').toUpperCase().includes('DISPOSICION')).length;
        const reincidentes = data.filter(row => parseInt(row.dias_distintos) >= 3).length;
        
        const sortedDias = [...diasArray].sort((a, b) => a - b);
        const mediana = sortedDias.length % 2 === 0
            ? ((sortedDias[sortedDias.length / 2 - 1] + sortedDias[sortedDias.length / 2]) / 2).toFixed(1)
            : sortedDias[Math.floor(sortedDias.length / 2)];

        document.getElementById('totalPersonas').textContent = totalPersonas;
        document.getElementById('totalDetenciones').textContent = totalDetenciones;
        document.getElementById('promedioDetenciones').textContent = promedio;
        document.getElementById('maxDetenciones').textContent = maxDetenciones;
        document.getElementById('faltasAdmin').textContent = faltasAdmin;
        document.getElementById('disposiciones').textContent = disposiciones;
        document.getElementById('reincidentes').textContent = reincidentes;
        document.getElementById('medianaDetenciones').textContent = mediana;

        stats.classList.add('show');
    }

    function updateChartCarousel() {
        const offset = -currentChartIndex * (100 / totalCharts); 
        carouselTrack.style.transform = `translateX(${offset}%)`;
    }

    function createCharts(data) {
        destroyCharts();
        chartsSection.classList.add('show');
        currentChartIndex = 0;
        updateChartCarousel();

        createDistributionChart(data);
        createTopPersonsChart(data);
        createDelitosChart(data);
        createWeekdayChart(data);
    }

    function createDistributionChart(data) {
        const diasCounts = {};
        data.forEach(row => {
            const dias = parseInt(row.dias_distintos) || 0;
            diasCounts[dias] = (diasCounts[dias] || 0) + 1;
        });
        const labels = Object.keys(diasCounts).sort((a, b) => a - b);
        const values = labels.map(label => diasCounts[label]);
        const ctx = document.getElementById('distributionChart').getContext('2d');
        charts.distribution = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels.map(l => l + ' días'),
                datasets: [{ label: 'Número de Personas', data: values, backgroundColor: 'rgba(102, 126, 234, 0.8)', borderColor: 'rgba(102, 126, 234, 1)', borderWidth: 2 }]
            },
            options: { responsive: true, maintainAspectRatio: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { precision: 0 } } } }
        });
    }

    function createTopPersonsChart(data) {
        const sorted = [...data].sort((a, b) => (parseInt(b.dias_distintos) || 0) - (parseInt(a.dias_distintos) || 0)).slice(0, 10);
        const ctx = document.getElementById('topPersonsChart').getContext('2d');
        charts.topPersons = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: sorted.map(row => row.persona.split(' ').slice(0, 2).join(' ')),
                datasets: [{ label: 'Días de Detención', data: sorted.map(row => parseInt(row.dias_distintos) || 0), backgroundColor: 'rgba(231, 76, 60, 0.8)', borderColor: 'rgba(231, 76, 60, 1)', borderWidth: 2 }]
            },
            options: { indexAxis: 'y', responsive: true, maintainAspectRatio: true, plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true, ticks: { precision: 0 } } } }
        });
    }

    function createDelitosChart(data) {
        const delitosCounts = {};
        data.forEach(row => {
            const delitos = (row.delitos || '').split(',');
            delitos.forEach(delito => {
                const d = delito.trim().toUpperCase();
                if (d) delitosCounts[d] = (delitosCounts[d] || 0) + 1;
            });
        });
        const labels = Object.keys(delitosCounts);
        const values = labels.map(label => delitosCounts[label]);
        const ctx = document.getElementById('delitosChart').getContext('2d');
        charts.delitos = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{ data: values, backgroundColor: ['rgba(142, 68, 173, 0.8)', 'rgba(52, 152, 219, 0.8)', 'rgba(46, 204, 113, 0.8)', 'rgba(241, 196, 15, 0.8)', 'rgba(230, 126, 34, 0.8)'], borderWidth: 2 }]
            },
            options: { responsive: true, maintainAspectRatio: true, plugins: { legend: { position: 'bottom' } } }
        });
    }

    function createWeekdayChart(data) {
        const weekdayCounts = { 'Lun': 0, 'Mar': 0, 'Mié': 0, 'Jue': 0, 'Vie': 0, 'Sáb': 0, 'Dom': 0 };
        const weekdayNames = ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'];
        data.forEach(row => {
            const fechas = (row.fechas_detectado || '').split(',');
            fechas.forEach(fecha => {
                const f = fecha.trim();
                if (f) {
                    const date = new Date(f);
                    if (!isNaN(date)) {
                        const dayName = weekdayNames[date.getDay()];
                        weekdayCounts[dayName]++;
                    }
                }
            });
        });
        const ctx = document.getElementById('weekdayChart').getContext('2d');
        charts.weekday = new Chart(ctx, {
            type: 'line',
            data: {
                labels: Object.keys(weekdayCounts),
                datasets: [{ label: 'Detenciones', data: Object.values(weekdayCounts), backgroundColor: 'rgba(39, 174, 96, 0.2)', borderColor: 'rgba(39, 174, 96, 1)', borderWidth: 3, fill: true, tension: 0.4 }]
            },
            options: { responsive: true, maintainAspectRatio: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { precision: 0 } } } }
        });
    }

    function destroyCharts() {
        Object.values(charts).forEach(chart => { if (chart) chart.destroy(); });
        charts = {};
    }

    function downloadExcel() {
        if (parsedData.length === 0) {
            showError('No hay datos para exportar');
            return;
        }
        const wb = XLSX.utils.book_new();
        const excelData = parsedData.map(row => ({
            'Persona': row.persona || '',
            'Días Distintos': row.dias_distintos || '',
            'Fechas Detectado': row.fechas_detectado || '',
            'Delitos': row.delitos || '',
            'Detalle del Delito': row.detalle_delito || ''
        }));
        const ws = XLSX.utils.json_to_sheet(excelData);
        ws['!cols'] = [ { wch: 30 }, { wch: 12 }, { wch: 40 }, { wch: 20 }, { wch: 80 } ];
        XLSX.utils.book_append_sheet(wb, ws, 'Registros de Detención');
        const timestamp = new Date().toISOString().slice(0,10);
        XLSX.writeFile(wb, `registros_detencion_${timestamp}.xlsx`);
    }

    // --- FUNCIÓN downloadPDF ACTUALIZADA PARA GRÁFICAS MÁS GRANDES ---
    async function downloadPDF() {
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'mm', 'a4');
        const pageWidth = pdf.internal.pageSize.getWidth();
        const pageHeight = pdf.internal.pageSize.getHeight();
        const margin = 15;
        let yPosition = 20;

        // --- TÍTULO Y FECHA ---
        pdf.setFontSize(18);
        pdf.setFont(undefined, 'bold');
        pdf.text('Reporte de Detenciones', pageWidth / 2, yPosition, { align: 'center' });
        yPosition += 8;
        pdf.setFontSize(10);
        pdf.setFont(undefined, 'normal');
        pdf.text(`Generado el: ${new Date().toLocaleDateString('es-MX')}`, pageWidth / 2, yPosition, { align: 'center' });
        yPosition += 15;

        // --- TABLA DE ESTADÍSTICAS ---
        pdf.setFontSize(12);
        pdf.setFont(undefined, 'bold');
        pdf.text('Estadísticas Generales', margin, yPosition);
        
        const statsBody = [
            ['Total de Personas:', document.getElementById('totalPersonas').textContent, 'Faltas Administrativas:', document.getElementById('faltasAdmin').textContent],
            ['Total de Detenciones:', document.getElementById('totalDetenciones').textContent, 'Disposiciones:', document.getElementById('disposiciones').textContent],
            ['Promedio por Persona:', document.getElementById('promedioDetenciones').textContent, 'Reincidentes (3+ días):', document.getElementById('reincidentes').textContent],
            ['Máximo de Detenciones:', document.getElementById('maxDetenciones').textContent, 'Mediana de Detenciones:', document.getElementById('medianaDetenciones').textContent]
        ];

        pdf.autoTable({
            body: statsBody,
            startY: yPosition + 6,
            theme: 'grid',
            styles: { fontSize: 9, cellPadding: 2 },
            columnStyles: {
                0: { fontStyle: 'bold', fillColor: [240, 240, 240], cellWidth: 50 },
                2: { fontStyle: 'bold', fillColor: [240, 240, 240], cellWidth: 50 },
                1: { halign: 'center' },
                3: { halign: 'center' }
            }
        });
        
        yPosition = pdf.autoTable.previous.finalY + 15;

        // --- GRÁFICAS EN UNA SOLA COLUMNA (MÁS GRANDES) ---
        pdf.setFontSize(12);
        pdf.setFont(undefined, 'bold');
        pdf.text('Análisis Gráfico', margin, yPosition);
        yPosition += 8;

        const chartIds = ['distributionChart', 'topPersonsChart', 'delitosChart', 'weekdayChart'];
        const imageWidth = pageWidth - margin * 2; // Ancho completo de la página menos márgenes

        for (const chartId of chartIds) {
            const canvas = document.getElementById(chartId);
            const aspectRatio = canvas.width / canvas.height;
            const imageHeight = imageWidth / aspectRatio; // Altura calculada para no deformar

            // Si la gráfica no cabe en la página actual, crea una nueva
            if (yPosition + imageHeight > pageHeight - margin) {
                pdf.addPage();
                yPosition = margin;
            }

            const imgData = canvas.toDataURL('image/png', 1.0);
            pdf.addImage(imgData, 'PNG', margin, yPosition, imageWidth, imageHeight);
            yPosition += imageHeight + 10; // Mover Y para la siguiente gráfica
        }
        
        // --- TABLA CON LOS PRIMEROS 20 REGISTROS ---
        if (parsedData.length > 0) {
            // Comprobar si hay espacio para el título de la tabla
            if (yPosition > pageHeight - 40) { 
                pdf.addPage();
                yPosition = margin;
            }
            pdf.setFontSize(12);
            pdf.setFont(undefined, 'bold');
            pdf.text('Primeros 20 Registros', margin, yPosition);
            
            const tableData = parsedData.slice(0, 20);
            const head = [['Persona', 'Días Distintos', 'Delitos', 'Detalle del Delito']];
            const body = tableData.map(row => [
                row.persona || '',
                row.dias_distintos || '0',
                row.delitos || '',
                row.detalle_delito || ''
            ]);

            pdf.autoTable({
                head: head,
                body: body,
                startY: yPosition + 8,
                headStyles: { fillColor: [52, 73, 94] },
                styles: { fontSize: 7, cellPadding: 1.5, overflow: 'linebreak' },
                columnStyles: {
                    0: { cellWidth: 40 },
                    1: { cellWidth: 15, halign: 'center' },
                    2: { cellWidth: 35 },
                    3: { cellWidth: 'auto' }
                }
            });
        }
        
        pdf.save(`reporte_detenciones_${new Date().toISOString().slice(0,10)}.pdf`);
    }

    function resetApp() {
        parsedData = [];
        filteredData = [];
        fileInput.value = '';
        fileName.textContent = '';
        tableBody.innerHTML = '';
        
        dataTable.classList.remove('show');
        stats.classList.remove('show');
        chartsSection.classList.remove('show');
        downloadSection.classList.remove('show');
        
        tableControls.classList.remove('show');
        paginationControls.classList.remove('show');
        searchInput.value = '';

        destroyCharts();
        hideError();
    }

    function showError(message) {
        errorMessage.textContent = message;
        errorMessage.style.display = 'block';
    }

    function hideError() {
        errorMessage.style.display = 'none';
    }
</script>
</body>
</html>